{% extends "base/layout.html" %}
{% load static %}
{% load my_filters %}
{% load render_table from django_tables2 %}
{% block title_text %}{{object.name|pluralize_word:True}}{% endblock title_text %}

{% block stylesheets_local %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'css/list.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/table.css' %}">
{% endblock stylesheets_local %}

{% block content %}
<div class="bodyHeader clearfix d-flex justify-content-between align-items-center" style="margin-bottom:8px;">
    <div class="floatLeft">
        <h1>My Dashboard</h1>
    </div>
    {% if request.user.is_authenticated %}
    <div>
        <button class="btn btn-outline-secondary btn-sm" id="toggleEditWidgets">
            <span class="fas fa-sliders-h"></span> Customize
        </button>
    </div>
    {% endif %}
</div>
<div class="bodyHeaderFooter clearfix">
    <div class="row">
        <div class="col-4 col-md-6">
            <p style="margin-top:5px;"><span id="ctl00_MainContent_lblDate">Saturday, January 25, 2025</span></p>
        </div>
        <div class="col-8 col-md-6">
            <div class="float-right">
                <div class="form-inline">
                    
                </div>
            </div>
        </div>
    </div>
</div>

<div class="dashboard-grid row g-3">
    <div id="hiddenWidgetPanel" class="col-12 {% if not hidden_widgets %}d-none{% endif %}">
        <div class="alert alert-warning d-flex flex-wrap align-items-center gap-2">
            <span class="me-2"><strong>Hidden widgets:</strong></span>
            {% if hidden_widgets %}
                {% for widget in hidden_widgets %}
                    <button class="btn btn-sm btn-outline-primary restore-widget" data-widget-key="{{ widget.key }}">
                        <span class="fas fa-undo me-1"></span>{{ widget.title }}
                    </button>
                {% endfor %}
                <button class="btn btn-sm btn-outline-danger ms-auto" id="restoreAllWidgets">
                    <span class="fas fa-sync me-1"></span> Restore All
                </button>
            {% else %}
                <span class="text-muted">None</span>
            {% endif %}
        </div>
    </div>
    {% if widgets %}
        {% for widget in widgets %}
            <div class="dashboard-card-column col-12 col-xl-{{ widget.width|default:12 }}" data-widget-key="{{ widget.key }}">
                <section class="dashboard-card card h-100" id="{{ widget.slug }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">{{ widget.title }}</h3>
                        <button class="btn btn-light btn-sm widget-toggle-btn d-none" data-widget-key="{{ widget.key }}">
                            <span class="fas fa-times"></span>
                        </button>
                        <div class="btn-group widget-move-controls d-none" role="group">
                            <button class="btn btn-light btn-sm widget-move-up" type="button" title="Move up">
                                <span class="fas fa-arrow-up"></span>
                            </button>
                            <button class="btn btn-light btn-sm widget-move-down" type="button" title="Move down">
                                <span class="fas fa-arrow-down"></span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if widget.template %}
                            {% include widget.template with widget=widget %}
                        {% elif widget.type == "table" and widget.table %}
                            {% render_table widget.table %}
                        {% elif widget.type == "chart" %}
                            <div class="chart-wrapper">
                                <canvas id="{{ widget.chart_id }}"></canvas>
                            </div>
                            <script>
                                (function() {
                                    const ctx = document.getElementById("{{ widget.chart_id }}").getContext("2d");
                                    const config = {{ widget.chart_config|safe }};
                                    new Chart(ctx, config);
                                })();
                            </script>
                        {% elif widget.type == "actions" %}
                            <div class="list-group">
                                {% for action in widget.actions %}
                                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ action.url }}">
                                        {% if action.icon %}<span class="{{ action.icon }} me-2"></span>{% endif %}
                                        {{ action.label }}
                                    </a>
                                {% empty %}
                                    <p class="text-muted mb-0">No quick actions available.</p>
                                {% endfor %}
                            </div>
                        {% elif widget.type == "metrics" %}
                            <div class="row g-3">
                                {% for metric in widget.metrics %}
                                    <div class="col-6">
                                        <div class="metric-card">
                                            <div class="metric-label">{{ metric.label }}</div>
                                            <div class="metric-value">{{ metric.value }}</div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="mb-0">{{ widget.content|default:"" }}</p>
                        {% endif %}
                    </div>
                </section>
            </div>
        {% endfor %}
{% else %}
        <div class="col-12">
            <section class="card h-100 text-center py-5">
                <p class="text-muted mb-0">No widgets are configured for this dashboard yet.</p>
            </section>
        </div>
    {% endif %}
</div>

{% block javascripts_local %}
{{ block.super }}
<script>
    (function () {
        const toggleButton = document.getElementById("toggleEditWidgets");
        if (!toggleButton) return;

        let editMode = false;
        const cards = document.querySelectorAll(".dashboard-card");
        const portalKey = "{{ dashboard_portal_key|default:'' }}";

        toggleButton.addEventListener("click", function () {
            editMode = !editMode;
            cards.forEach(card => {
                const btn = card.querySelector(".widget-toggle-btn");
                const moveControls = card.querySelector(".widget-move-controls");
                if (btn) {
                    btn.classList.toggle("d-none", !editMode);
                }
                if (moveControls) {
                    moveControls.classList.toggle("d-none", !editMode);
                }
            });
            toggleButton.classList.toggle("btn-outline-secondary", !editMode);
            toggleButton.classList.toggle("btn-danger", editMode);
            toggleButton.innerHTML = editMode ? '<span class="fas fa-check"></span> Done' : '<span class="fas fa-sliders-h"></span> Customize';
            if (!editMode) {
                const order = Array.from(document.querySelectorAll(".dashboard-card-column"))
                    .map(col => col.dataset.widgetKey)
                    .filter(Boolean);
                if (window.CF && window.CF.saveDashboardPrefs) {
                    window.CF.saveDashboardPrefs({
                        action: "save_layout",
                        layout: order,
                        portal_key: portalKey
                    });
                }
            }
        });

        document.querySelectorAll(".widget-toggle-btn").forEach(button => {
            button.addEventListener("click", function () {
                const key = this.dataset.widgetKey;
                const card = this.closest(".dashboard-card");
                if (!key || !card) return;

                card.classList.add("d-none");
                if (window.CF && window.CF.saveDashboardPrefs) {
                    window.CF.saveDashboardPrefs({
                        action: "hide_widget",
                        widget_key: key,
                        portal_key: portalKey
                    }).then(() => window.location.reload())
                      .catch(() => {
                        card.classList.remove("d-none");
                      });
                }
            });
        });

        document.getElementById("restoreAllWidgets")?.addEventListener("click", function () {
            if (!(window.CF && window.CF.saveDashboardPrefs)) {
                return;
            }
            window.CF.saveDashboardPrefs({
                action: "reset_hidden",
                portal_key: portalKey
            }).then(() => window.location.reload());
        });

        document.querySelectorAll(".restore-widget").forEach(button => {
            button.addEventListener("click", function () {
                const key = this.dataset.widgetKey;
                if (!key || !(window.CF && window.CF.saveDashboardPrefs)) {
                    return;
                }
                window.CF.saveDashboardPrefs({
                    action: "show_widget",
                    widget_key: key,
                    portal_key: portalKey
                }).then(() => window.location.reload());
            });
        });

        function moveCard(button, direction) {
            const card = button.closest(".dashboard-card");
            if (!card) return;
            const column = card.closest(".dashboard-card-column");
            if (!column) return;
            const sibling = direction === "up" ? column.previousElementSibling : column.nextElementSibling;
            if (sibling && sibling.classList.contains("dashboard-card-column")) {
                if (direction === "up") {
                    column.parentNode.insertBefore(column, sibling);
                } else {
                    column.parentNode.insertBefore(sibling, column);
                }
            }
        }

        document.querySelectorAll(".widget-move-up").forEach(btn => {
            btn.addEventListener("click", () => moveCard(btn, "up"));
        });
        document.querySelectorAll(".widget-move-down").forEach(btn => {
            btn.addEventListener("click", () => moveCard(btn, "down"));
        });
    })();
</script>
{% endblock javascripts_local %}

{% endblock %}
